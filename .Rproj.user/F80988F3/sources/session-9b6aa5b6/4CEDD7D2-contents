# ---- –ü–∞–∫–µ—Ç–∏ ----
library(shiny)
library(dplyr)
library(tidyr)
library(readxl)
library(recommenderlab)
library(purrr)
library(tibble)
library(openxlsx)
library(tools)
library(rsconnect)

getwd()
list.files()


library(rsconnect)
rsconnect::deployApp(getwd())

library(rsconnect)

rsconnect::deployApp(
  appDir = ".",
  appName = "category_recs_app_gbar"
)

library(rsconnect)

rsconnect::deployApp(
  appDir  = ".",
  appName = "category_recs_app_gbar"
)

# –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –ø–∞–∫–µ—Ç –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞–Ω—ñ—Ñ–µ—Å—Ç—ñ–≤
install.packages("rsconnect")

# –ó–≥–µ–Ω–µ—Ä—É–π—Ç–µ —Ñ–∞–π–ª –º–∞–Ω—ñ—Ñ–µ—Å—Ç—É (–ø–µ—Ä–µ–±—É–≤–∞—é—á–∏ –≤ –ø–∞–ø—Ü—ñ –ø—Ä–æ–µ–∫—Ç—É)
rsconnect::writeManifest()

# ---- –ü–∞–∫–µ—Ç–∏ ----
library(shiny)
library(shinythemes)
library(dplyr)
library(tidyr)
library(readxl)
library(recommenderlab)
library(purrr)
library(tibble)
library(openxlsx)
library(tools)
library(DT)
library(shinyjs)
library(shinycssloaders)


# >>> NEW: –¥–ª—è KPI/–∫–∞—Ä—Ç–æ–∫ (–ø—Ä–æ—Å—Ç–∏–π HTML)
library(htmltools)

options(shiny.maxRequestSize = 500 * 1024^2)


# ---- UI ----
ui <- fluidPage(
  useShinyjs(),
  
  
  
  theme = shinytheme("flatly"),
  tags$head(
    tags$style(HTML("
      /* ===== –û–°–ù–û–í–ù–ê –ü–ê–õ–Ü–¢–†–ê ===== */
      :root {
        --brand-main: #1B065E;
        --brand-accent: #D68FD6;
        --bg-light: #f7f8fa;
        --border-light: #e6e6ee;
      }
      body { background-color: var(--bg-light); color: #2b2b2b; }
      h1, h2, h3, h4, h5, h6 { color: var(--brand-main) !important; font-weight: 600; }
      a { color: var(--brand-main); }
      a:hover { color: var(--brand-accent); text-decoration: none; }

      .well-custom {
        background-color: #ffffff;
        border-radius: 10px;
        border: 1px solid var(--border-light);
        box-shadow: 0 4px 10px rgba(27,6,94,0.05);
        padding: 18px 22px;
        margin-bottom: 20px;
      }

      .btn-primary {
        background-color: var(--brand-main) !important;
        border-color: var(--brand-main) !important;
        color: #ffffff !important;
        font-weight: 500;
      }
      .btn-primary:hover { background-color: var(--brand-accent) !important; border-color: var(--brand-accent) !important; }

      .btn-success {
        background-color: var(--brand-accent) !important;
        border-color: var(--brand-accent) !important;
        color: #1B065E !important;
        font-weight: 500;
      }
      .btn-success:hover { background-color: #c87fc8 !important; border-color: #c87fc8 !important; }

      .download-btn { width: 100%; margin-bottom: 8px; }
      .nav-tabs > li > a { color: var(--brand-main); font-weight: 500; }
      .nav-tabs > li.active > a, .nav-tabs > li.active > a:hover {
        color: var(--brand-main); background-color: #ffffff; border-bottom: 3px solid var(--brand-accent);
      }

      .shiny-notification {
        background-color: #ffffff;
        color: var(--brand-main);
        border-left: 5px solid var(--brand-accent);
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        font-size: 14px;
      }

      small, .help-block { color: #6b6b8a; }

      /* >>> NEW: KPI cards */
      .kpi-row { display: flex; gap: 12px; flex-wrap: wrap; }
      .kpi-card {
        flex: 1 1 170px;
        background: #fff;
        border: 1px solid var(--border-light);
        border-radius: 12px;
        padding: 14px 16px;
        box-shadow: 0 4px 10px rgba(27,6,94,0.05);
      }
      .kpi-title { font-size: 12px; color: #6b6b8a; margin-bottom: 6px; }
      .kpi-value { font-size: 22px; font-weight: 700; color: var(--brand-main); line-height: 1.1; }
      .kpi-sub { font-size: 12px; color: #6b6b8a; margin-top: 6px; }

      /* >>> NEW: step label */
      .step-badge {
        display: inline-block;
        font-size: 12px;
        padding: 3px 8px;
        border-radius: 999px;
        background: #F1D7F1;
        color: var(--brand-main);
        font-weight: 600;
        margin-right: 8px;
      }

      .hero-title { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
      .hero-sub { color: #4f4f6f; margin-bottom: 10px; }
      .hero-bullets { margin: 0; padding-left: 18px; }
    "))
  ),
  
  div(
    id = "login_panel",
    class = "container",
    style = "max-width: 420px; margin-top: 120px;",
    wellPanel(
      h3("–í—Ö—ñ–¥ –¥–æ –¥–æ–¥–∞—Ç–∫—É"),
      passwordInput("password", "–ü–∞—Ä–æ–ª—å"),
      actionButton("login", "–£–≤—ñ–π—Ç–∏", class = "btn-primary"),
      br(), br(),
      textOutput("login_msg")
    )
  ),
  
  hidden(
    div(
      id = "app_panel",
      
      titlePanel("–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ–π"),
      
      sidebarLayout(
        sidebarPanel(
          # >>> NEW: Value proposition + –¥–µ–º–æ
          div(class = "well-custom",
              div(class = "hero-title", "–ü–æ—Ä–∞–¥–∏ –¥–ª—è CRM —Ç–∞ –∫—Ä–æ—Å-—Å–µ–π–ª—É –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏"),
              div(class = "hero-sub",
                  "–®–≤–∏–¥–∫–æ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ–∫—É–ø–æ–∫ —É –≥–æ—Ç–æ–≤—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –¥–ª—è –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ–π (email/SMS/push) —Ç–∞ —Å–µ–≥–º–µ–Ω—Ç—ñ–≤."
              ),
              tags$ul(class = "hero-bullets",
                      tags$li("–ì–æ—Ç–æ–≤–∏–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π –ø–æ –∫–ª—ñ—î–Ω—Ç–∞—Ö"),
                      tags$li("–û—Ü—ñ–Ω–∫–∞ –ø–æ–∫—Ä–∏—Ç—Ç—è —Ç–∞ –¢–û–ü –∫–∞—Ç–µ–≥–æ—Ä—ñ–π"),
                      tags$li("–ï–∫—Å–ø–æ—Ä—Ç —É Excel –¥–ª—è CRM")
              )
          ),
          
          # 1. –î–∞–Ω—ñ
          div(class = "well-custom",
              h4(tags$span(class="step-badge","–ö—Ä–æ–∫ 1"), "–î–∞–Ω—ñ"),
              fileInput(
                "file",
                "–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª (xlsx/csv)",
                accept = c(".xlsx", ".xls", ".csv")
              ),
              # >>> NEW: —à–∞–±–ª–æ–Ω
              downloadButton("download_template", "–°–∫–∞—á–∞—Ç–∏ —à–∞–±–ª–æ–Ω —Ñ–∞–π–ª—É", class = "btn btn-default btn-block"),
              br(),
              uiOutput("file_check_ui"),
              helpText(
                "–û—á—ñ–∫—É–≤–∞–Ω—ñ –∫–æ–ª–æ–Ω–∫–∏ —É —Ñ–∞–π–ª—ñ:",
                tags$br(),
                tags$b("client_id"), " ‚Äì ID –∫–ª—ñ—î–Ω—Ç–∞;",
                tags$br(),
                tags$b("–ö–∞—Ç–µ–≥–æ—Ä—ñ—è 2 —Ä—ñ–≤–Ω—è"), " ‚Äì –Ω–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó;",
                tags$br(),
                tags$b("brand"), " ‚Äì (–æ–ø—Ü—ñ–π–Ω–æ) –±—Ä–µ–Ω–¥."
              )
              
          ),
          
          # 2. –ü–∞—Ä–∞–º–µ—Ç—Ä–∏
          div(class = "well-custom",
              h4(tags$span(class="step-badge","–ö—Ä–æ–∫ 2"), "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è"),
              numericInput("max_cats", "–°–∫—ñ–ª—å–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –±–µ—Ä–µ–º–æ —É –º–æ–¥–µ–ª—å (TO–ü –Ω–∞–π–ø–æ–ø—É–ª—è—Ä–Ω—ñ—à–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π)", value = 100, min = 10),
              br(), br(),
              numericInput("max_users", "–°–∫—ñ–ª—å–∫–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∞–Ω–∞–ª—ñ–∑—É—î–º–æ", value = 1000, min = 100),
              br(), br(),
              numericInput("top_n", "–°–∫—ñ–ª—å–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–≤–∞—Ç–∏ –∫–æ–∂–Ω–æ–º—É –∫–ª—ñ—î–Ω—Ç—É (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π)", value = 5, min = 1),
              br(), br(),
              actionButton("use_recommended", "–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è", class = "btn btn-default btn-block"),
              br(),
              checkboxInput("use_brand", "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—è + –±—Ä–µ–Ω–¥ (–¥–ª—è –¥–µ–º–æ)", value = FALSE),
              conditionalPanel(
                condition = "input.use_brand == true",
                numericInput("brands_per_cat", "–ë—Ä–µ–Ω–¥—ñ–≤ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é (–¥–µ–º–æ)", value = 3, min = 1, max = 10),
                helpText("–Ø–∫—â–æ —É —Ñ–∞–π–ª—ñ –Ω–µ–º–∞—î –±—Ä–µ–Ω–¥—É ‚Äî –¥–æ–¥–∞—Ç–æ–∫ –∑–≥–µ–Ω–µ—Ä—É—î –¥–µ–º–æ-–±—Ä–µ–Ω–¥–∏ –¥–ª—è –∫–æ–∂–Ω–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó.")
              ),
              br(), br(),
              
              actionButton("run", "–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –º–æ–¥–µ–ª—å", class = "btn btn-primary btn-block"),
              br(),
              
              div(
                id = "calc_status",
                style = "display:none; text-align:center; margin-top:10px;",
                tags$div(
                  tags$strong("–ô–¥–µ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫‚Ä¶"),
                  br(),
                  tags$small("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞—á–µ–∫–∞–π—Ç–µ. –¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ –¥–µ–∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –≤–∏–±—Ä–∞–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∫–ª—ñ—î–Ω—Ç—ñ–≤.")
                )
              )
              
          ),
          
          # 3. –ï–∫—Å–ø–æ—Ä—Ç
          div(class = "well-custom",
              h4(tags$span(class="step-badge","–ö—Ä–æ–∫ 3"), "–ï–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤"),
              tags$small("–î–æ—Å—Ç—É–ø–Ω—ñ –ø—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É –º–æ–¥–µ–ª—ñ"),
              br(), br(),
              downloadButton("download_rank", "–†–∞–Ω–≥–æ–≤—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó (rank_matrix.xlsx)", class = "btn btn-success download-btn"),
              downloadButton("download_purchase", "–ú–∞—Ç—Ä–∏—Ü—è 0/1 (client_category_matrix.xlsx)", class = "btn btn-default download-btn"),
              downloadButton("download_rec_list", "–°–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π (recommendations_list.xlsx)", class = "btn btn-default download-btn"),
              downloadButton("download_combined", "–ü–æ–∫—É–ø–∫–∏ 0/1 + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó (combined.xlsx)", class = "btn btn-success download-btn")
          ),
          width = 4
        ),
        
        mainPanel(
          tabsetPanel(
            tabPanel(
              "–û–≥–ª—è–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤",
              br(),
              # >>> NEW: KPI cards
              div(class = "well-custom",
                  h4("–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—É—Å–∫—É ‚Äî –∫–æ—Ä–æ—Ç–∫–æ"),
                  uiOutput("kpi_cards")
              ),
              div(class = "well-custom",
                  h4("–¢–û–ü —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π"),
                  tableOutput("top_categories_all")
              ),
              div(class = "well-custom",
                  h4("–ü–µ—Ä–µ–≥–ª—è–¥ –ø–æ –∫–ª—ñ—î–Ω—Ç—É: –ø–æ–∫—É–ø–∫–∏ vs —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó"),
                  uiOutput("client_picker_ui"),
                  br(),
                  tableOutput("client_view")
              )
            ),
            
            tabPanel(
              "–¢–∞–±–ª–∏—Ü—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π",
              br(),
              
              # ‚úÖ –ù–û–í–ò–ô –ë–õ–û–ö –§–Ü–õ–¨–¢–†–ê
              div(class = "well-custom",
                  h4("–§—ñ–ª—å—Ç—Ä: –∫–ª—ñ—î–Ω—Ç –∫—É–ø—É–≤–∞–≤ –æ–±—Ä–∞–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (buy_*)"),
                  fluidRow(
                    column(
                      8,
                      selectizeInput(
                        "buy_multi_filter",
                        "–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (–º–æ–∂–Ω–∞ –∫—ñ–ª—å–∫–∞)",
                        choices = NULL,
                        multiple = TRUE,
                        options = list(
                          placeholder = "–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó‚Ä¶",
                          plugins = list("remove_button")
                        )
                      )
                    ),
                    column(
                      4,
                      radioButtons(
                        "buy_multi_mode",
                        "–£–º–æ–≤–∞",
                        choices = c("–£—Å—ñ –æ–±—Ä–∞–Ω—ñ (AND)" = "AND", "–ë—É–¥—å-—è–∫–∞ –∑ –æ–±—Ä–∞–Ω–∏—Ö (OR)" = "OR"),
                        inline = TRUE,
                        selected = "AND"
                      )
                    )
                  ),
                  tags$small("–ü–æ—Ä–∞–¥–∞: –æ–±–µ—Ä—ñ—Ç—å 2‚Äì4 –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó, —â–æ–± –∑–Ω–∞–π—Ç–∏ ‚Äú–ø–µ—Ä–µ—Ç–∏–Ω–∏‚Äù –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞/–∫–∞–º–ø–∞–Ω—ñ—ó.")
              )
              ,
              
              # ‚úÖ –¢–ê–ë–õ–ò–¶–Ø
              div(class = "well-custom",
                  h4("–ü–æ–∫—É–ø–∫–∏ 0/1 + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó ‚Äî –ø–µ—Ä–µ–≥–ª—è–¥ —É –¥–æ–¥–∞—Ç–∫—É"),
                  tags$small("–ó—Ä—É—á–Ω–æ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∑–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—é –ø–æ–∫—É–ø–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó."),
                  br(), br(),
                  DTOutput("combined_table")
              ),
              
              # (–∑–∞–ª–∏—à–∞—î–º–æ summary ‚Äî –≤–æ–Ω–æ –∫–æ—Ä–∏—Å–Ω–µ)
              div(class = "well-custom",
                  h4("–ö–æ—Ä–æ—Ç–∫–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∑–∞–ø—É—Å–∫"),
                  verbatimTextOutput("summary")
              )
            )
            
            ,
            
            tabPanel(
              "–ü—Ä–æ –¥–æ–¥–∞—Ç–æ–∫",
              br(),
              div(class = "well-custom",
                  h3("–Ø–∫ –ø—Ä–∞—Ü—é—î —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π"),
                  p("–î–æ–¥–∞—Ç–æ–∫ –∞–Ω–∞–ª—ñ–∑—É—î –ø–æ–∫—É–ø–∫–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤ —ñ –ø—Ä–æ–ø–æ–Ω—É—î –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó, —è–∫—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏–º–∏."),
                  tags$ul(
                    tags$li("–§–∞–π–ª –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —É –º–∞—Ç—Ä–∏—Ü—é –∫–ª—ñ—î–Ω—Ç √ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—è (0/1)."),
                    tags$li("–ë–µ—Ä—É—Ç—å—Å—è TOP-–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –∑–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ñ—Å—Ç—é."),
                    tags$li("–ë—É–¥—É—î—Ç—å—Å—è –º–æ–¥–µ–ª—å UBCF –∑ –º—ñ—Ä–æ—é Jaccard."),
                    tags$li("–§–æ—Ä–º—É—é—Ç—å—Å—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –¥–ª—è test-–≤–∏–±—ñ—Ä–∫–∏."),
                    tags$li("–î–æ—Å—Ç—É–ø–Ω—ñ 4 —Ñ–∞–π–ª–∏ –µ–∫—Å–ø–æ—Ä—Ç—É, –≤–∫–ª—é—á–Ω–æ –∑ –∫–æ–º–±—ñ–Ω–æ–≤–∞–Ω–æ—é —Ç–∞–±–ª–∏—Ü–µ—é.")
                  ),
                  tags$small("–í–∞—à—ñ –¥–∞–Ω—ñ –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –ª–∏—à–µ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É.")
              )
            )
          ),
          width = 8
        )
      )
    )
  )
)

# ---- SERVER ----
server <- function(input, output, session) {
  
  rv <- reactiveValues(
    # exports
    rank_matrix_export = NULL,
    purchase_dim = NULL,
    purchase_export = NULL,
    rec_list_export = NULL,
    combined_export = NULL,
    top_categories_all = NULL,
    top_categories_test = NULL,
    quality_summary = NULL,
    quality_details = NULL,
    
    # >>> NEW: dataset + per-client view
    df_raw = NULL,
    interactions = NULL,
    client_options = NULL
  )
  
  # --- QUALITY HELPERS (holdout evaluation) ---
  calc_metrics_at_k <- function(recs, truth, k) {
    if (length(truth) == 0) {
      return(list(
        precision = NA_real_, recall = NA_real_,
        hit = NA_real_, ap = NA_real_, ndcg = NA_real_
      ))
    }
    
    recs <- recs[!is.na(recs) & recs != ""]
    if (length(recs) == 0) {
      return(list(precision = 0, recall = 0, hit = 0, ap = 0, ndcg = 0))
    }
    
    recs_k <- recs[seq_len(min(k, length(recs)))]
    hits <- recs_k %in% truth
    
    precision <- sum(hits) / k
    recall <- sum(hits) / length(truth)
    hitrate <- as.numeric(any(hits))
    
    # AP@K
    if (sum(hits) == 0) {
      ap <- 0
    } else {
      prec_at_i <- cumsum(hits) / seq_along(hits)
      ap <- sum(prec_at_i[hits]) / min(length(truth), k)
    }
    
    # nDCG@K (binary relevance)
    rel <- as.numeric(hits)
    dcg <- sum((2^rel - 1) / log2(seq_along(rel) + 1))
    ideal_rel <- c(rep(1, min(length(truth), k)), rep(0, k - min(length(truth), k)))
    idcg <- sum((2^ideal_rel - 1) / log2(seq_along(ideal_rel) + 1))
    ndcg <- ifelse(idcg == 0, 0, dcg / idcg)
    
    list(precision = precision, recall = recall, hit = hitrate, ap = ap, ndcg = ndcg)
  }
  
  make_holdout_newdata <- function(test_bin, keep_frac = 0.9, seed = 123) {
    set.seed(seed)
    m <- as(test_bin, "matrix")
    item_names <- colnames(m)
    
    n <- nrow(m)
    given_mat <- matrix(0, nrow = n, ncol = ncol(m))
    colnames(given_mat) <- item_names
    rownames(given_mat) <- rownames(m)
    
    truth_list <- vector("list", length = n)
    names(truth_list) <- rownames(m)
    
    keep_ids <- logical(n)
    
    for (i in seq_len(n)) {
      items <- which(m[i, ] > 0)
      if (length(items) < 2) {
        keep_ids[i] <- FALSE
        truth_list[[i]] <- character(0)
        next
      }
      
      given_n <- max(1, floor(length(items) * keep_frac))
      given <- sample(items, size = given_n)
      truth <- setdiff(items, given)
      
      if (length(truth) == 0) {
        keep_ids[i] <- FALSE
        truth_list[[i]] <- character(0)
        next
      }
      
      given_mat[i, given] <- 1
      truth_list[[i]] <- item_names[truth]
      keep_ids[i] <- TRUE
    }
    
    given_mat <- given_mat[keep_ids, , drop = FALSE]
    truth_list <- truth_list[keep_ids]
    
    newdata <- as(given_mat, "binaryRatingMatrix")
    list(newdata = newdata, truth = truth_list, given_mat = given_mat)
  }
  
  # --- NORMALIZATION HELPERS (for category | brand logic) ---
  
  norm <- function(x) {
    x <- as.character(x)
    x <- trimws(x)
    x <- gsub("\\s+", " ", x)
    tolower(x)
  }
  
  # —è–∫—â–æ item –º–∞—î —Ñ–æ—Ä–º–∞—Ç "–∫–∞—Ç–µ–≥–æ—Ä—ñ—è | –±—Ä–µ–Ω–¥"
  get_cat <- function(x) {
    x <- norm(x)
    sub("\\s*\\|.*$", "", x)   # —É—Å–µ –¥–æ —Å–∏–º–≤–æ–ª—É |
  }
  
  
  correct_password <- "X@4!Q8$R7M2ZP"  # üîê
  
  observeEvent(input$login, {
    if (input$password == correct_password) {
      shinyjs::hide("login_panel")
      shinyjs::show("app_panel")
    } else {
      output$login_msg <- renderText("–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å")
    }
  })
  
  # >>> NEW: recommended settings button
  observeEvent(input$use_recommended, {
    updateNumericInput(session, "max_cats", value = 100)
    updateNumericInput(session, "max_users", value = 3000)
    updateNumericInput(session, "top_n", value = 5)
    showNotification("–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚úÖ", type = "message")
  })
  
  # >>> NEW: download template
  output$download_template <- downloadHandler(
    filename = function() "template_client_category.xlsx",
    content = function(file) {
      tmp <- data.frame(
        client_id = c("C001","C001","C002","C003","C003"),
        `–ö–∞—Ç–µ–≥–æ—Ä—ñ—è 2 —Ä—ñ–≤–Ω—è` = c("Coffee","Books","Tea","Books","Desserts"),
        check.names = FALSE
      )
      
      openxlsx::write.xlsx(tmp, file)
    }
  )
  
  observeEvent(rv$combined_export, {
    req(rv$combined_export)
    
    buy_cols <- grep("^buy_", names(rv$combined_export), value = TRUE)
    buy_names <- sub("^buy_", "", buy_cols)
    
    updateSelectizeInput(
      session,
      "buy_multi_filter",
      choices = buy_names,
      selected = character(0),
      server = TRUE
    )
  })
  
  
  
  # >>> NEW: demo data button
  observeEvent(input$use_demo, {
    set.seed(42)
    demo_clients <- sprintf("C%04d", 1:300)
    demo_cats <- c("Coffee","Tea","Books","Desserts","Sandwiches","Wine","Gifts","Kids","Stationery","Home","Beauty","Snacks")
    df_demo <- tibble(
      client_id = sample(demo_clients, 3500, replace = TRUE),
      `–ö–∞—Ç–µ–≥–æ—Ä—ñ—è 2 —Ä—ñ–≤–Ω—è` = sample(demo_cats, 3500, replace = TRUE, prob = c(0.14,0.10,0.13,0.10,0.07,0.05,0.06,0.06,0.07,0.07,0.07,0.08))
    ) %>% distinct()
    rv$df_raw <- df_demo
    showNotification("–î–µ–º–æ-–¥–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ ‚úÖ –¢–µ–ø–µ—Ä –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –º–æ–¥–µ–ª—å¬ª.", type = "message")
  })
  
  # >>> NEW: file reading + column check UI (doesn't run model)
  observeEvent(input$file, {
    req(input$file)
    ext <- tools::file_ext(input$file$name)
    if (ext %in% c("xlsx", "xls")) {
      df <- read_excel(input$file$datapath)
    } else if (ext == "csv") {
      df <- read.csv(input$file$datapath, stringsAsFactors = FALSE)
    } else {
      rv$df_raw <- NULL
      showNotification("–ù–µ–ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É", type = "error")
      return(NULL)
    }
    rv$df_raw <- df
  })
  
  output$file_check_ui <- renderUI({
    df <- rv$df_raw
    if (is.null(df)) return(NULL)
    
    needed_cols <- c("client_id", "–ö–∞—Ç–µ–≥–æ—Ä—ñ—è 2 —Ä—ñ–≤–Ω—è")
    missing <- setdiff(needed_cols, colnames(df))
    found <- intersect(needed_cols, colnames(df))
    
    if (length(missing) > 0) {
      div(
        tags$small(tags$b("–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ñ–∞–π–ª—É: "), style="color:#6b6b8a;"),
        tags$div(style="margin-top:6px;",
                 tags$span(style="color:#1B065E;font-weight:600;", "–ó–Ω–∞–π–¥–µ–Ω–æ: "),
                 paste(found, collapse = ", ")
        ),
        tags$div(style="margin-top:4px;color:#b00020;font-weight:600;",
                 "–ù–µ –≤–∏—Å—Ç–∞—á–∞—î: ", paste(missing, collapse = ", ")
        )
      )
    } else {
      div(
        tags$div(style="color:#1f7a1f;font-weight:600;",
                 "‚úÖ –§–∞–π–ª –∫–æ—Ä–µ–∫—Ç–Ω–∏–π. –ö–æ–ª–æ–Ω–∫–∏ –∑–Ω–∞–π–¥–µ–Ω—ñ: ", paste(needed_cols, collapse = ", ")
        ),
        tags$small("–ú–æ–∂–Ω–∞ –∑–∞–ø—É—Å–∫–∞—Ç–∏ –º–æ–¥–µ–ª—å.")
      )
    }
  })
  
  # ---- RUN MODEL ----
  observeEvent(input$run, {
    
    disable("run")
    shinyjs::show("calc_status")
    
    withProgress(message = "–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π", value = 0, {
      
      incProgress(0.1, detail = "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö")
      
      # =========================
      # RULES / POLICY (MUST BE BEFORE predict/map2)
      # =========================
      
      never_recommend <- c(
        "–∂–µ–Ω—Å–∫–∏–µ –≥–∏–≥–∏–µ–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–¥–µ–ª–∏—è",
        "—Å—Ä–µ–¥—Å—Ç–≤–∞ –∏–Ω—Ç–∏–º–Ω–æ–π –≥–∏–≥–∏–µ–Ω—ã",
        "–∫–æ—Ä–º"
      )
      
      tobacco_cat <- c("—Å–∏–≥–∞—Ä–µ—Ç—ã")
      
      alcohol_cats <- c(
        "–≤–æ–¥–∫–∞","–≤–∏—Å–∫–∏","–∫–æ–Ω—å—è–∫","–±—Ä–µ–Ω–¥–∏","–≤–∏–Ω–æ —Ç–∏—Ö–æ–µ","–≤–∏–Ω–æ –∏–≥—Ä–∏—Å—Ç–æ–µ",
        "–ø–∏–≤–æ","—Å–∏–¥—Ä","–∫–æ–∫—Ç–µ–π–ª–∏ —Å–ª–∞–±–æ–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–µ"
      )
      
      kids_signal <- c(
        "–¥–µ—Ç—Å–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏",
        "—Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã –¥–µ—Ç—Å–∫–∏–µ",
        "–¥–µ—Ç—Å–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ"
      )
      
      kids_cat <- c(
        "–¥–µ—Ç—Å–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ",
        "–¥–µ—Ç—Å–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏",
        "—Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã –¥–µ—Ç—Å–∫–∏–µ",
        "–¥–µ—Ç—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã",
        "–ø–æ–¥–≥—É–∑–Ω–∏–∫–∏"
      )
      
      policy <- list(
        block_never_for_all = TRUE,
        block_tobacco_for_all = TRUE,
        allow_alcohol_only_if_bought_alcohol = TRUE,
        allow_kids_only_if_signal = TRUE,
        min_signal_count = 1
      )
      
      apply_rules <- function(recs, bought_items,
                              never_recommend, tobacco_cat, alcohol_cats,
                              kids_cat, kids_signal, policy) {
        
        recs <- recs[!is.na(recs) & recs != ""]
        recs <- norm(recs)
        bought_items <- norm(bought_items)
        
        # –∫–∞—Ç–µ–≥–æ—Ä—ñ–π–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª
        recs_cat <- get_cat(recs)
        bought_cat <- get_cat(bought_items)
        
        # –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ —Ç–µ, —â–æ –≤–∂–µ –∫—É–ø–∏–≤ (–ø–æ –ø–æ–≤–Ω–æ–º—É item, –∞–±–æ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó ‚Äî —è–∫ —Ö–æ—á–µ—à)
        recs <- recs[!recs_cat %in% bought_cat]
        
        if (isTRUE(policy$block_never_for_all)) {
          recs <- recs[!recs_cat %in% norm(never_recommend)]
        }
        
        if (isTRUE(policy$block_tobacco_for_all)) {
          recs <- recs[!recs_cat %in% norm(tobacco_cat)]
        }
        
        if (isTRUE(policy$allow_kids_only_if_signal)) {
          has_kids_signal <- length(intersect(bought_cat, norm(kids_signal))) >= policy$min_signal_count
          if (!has_kids_signal) recs <- recs[!recs_cat %in% norm(kids_cat)]
        }
        
        if (isTRUE(policy$allow_alcohol_only_if_bought_alcohol)) {
          has_alcohol <- length(intersect(bought_cat, norm(alcohol_cats))) >= 1
          if (!has_alcohol) recs <- recs[!recs_cat %in% norm(alcohol_cats)]
        }
        
        recs
      }
      
      
      # >>> NEW: use either uploaded or demo data
      df <- rv$df_raw
      if (is.null(df)) {
        showNotification("–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª.", type = "error")
        return(NULL)
      }
      
      # ---- 1a. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–ª–æ–Ω–æ–∫ ----
      needed_cols <- c("client_id", "–ö–∞—Ç–µ–≥–æ—Ä—ñ—è 2 —Ä—ñ–≤–Ω—è")
      missing <- setdiff(needed_cols, colnames(df))
      if (length(missing) > 0) {
        showNotification(
          paste0("–£ —Ñ–∞–π–ª—ñ –Ω–µ –≤–∏—Å—Ç–∞—á–∞—î –∫–æ–ª–æ–Ω–æ–∫: ", paste(missing, collapse = ", ")),
          type = "error"
        )
        return(NULL)
      }
      
      # –ü—Ä–∏–≤–æ–¥–∏–º–æ –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—Ö –Ω–∞–∑–≤
      # –ü—Ä–∏–≤–æ–¥–∏–º–æ –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ—ó –Ω–∞–∑–≤–∏ + —á–∏—Å—Ç–∏–º–æ —Ç–µ–∫—Å—Ç –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
      # --- 1) —á–∏—Å—Ç–∏–º–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é ---
      df <- df %>%
        mutate(
          category_lv2 = as.character(`–ö–∞—Ç–µ–≥–æ—Ä—ñ—è 2 —Ä—ñ–≤–Ω—è`),
          category_lv2 = trimws(category_lv2),
          category_lv2 = gsub("\\s+", " ", category_lv2)
        )
      
      use_brand <- isTRUE(input$use_brand)
      
      # --- 2) —è–∫—â–æ —Ä–µ–∂–∏–º category+brand ‚Äî –≤–∏–º–∞–≥–∞—î–º–æ –∫–æ–ª–æ–Ω–∫—É brand ---
      if (use_brand) {
        if (!("brand" %in% names(df))) {
          showNotification("–£ —Ñ–∞–π–ª—ñ –Ω–µ–º–∞—î –∫–æ–ª–æ–Ω–∫–∏ 'brand'. –í–∏–º–∫–Ω—ñ—Ç—å —Ä–µ–∂–∏–º '–∫–∞—Ç–µ–≥–æ—Ä—ñ—è + –±—Ä–µ–Ω–¥' –∞–±–æ –¥–æ–¥–∞–π—Ç–µ brand —É —Ñ–∞–π–ª.", type = "error")
          return(NULL)
        }
        
        df <- df %>%
          mutate(
            brand = as.character(brand),
            brand = trimws(brand),
            brand = gsub("\\s+", " ", brand)
          ) %>%
          # –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ –±—Ä–µ–Ω–¥–∏ (—â–æ–± –Ω–µ –±—É–ª–æ '–∫–∞—Ç–µ–≥–æ—Ä—ñ—è | ')
          filter(!is.na(brand), brand != "")
        
        df <- df %>%
          mutate(item = paste(category_lv2, brand, sep = " | "))
      } else {
        df <- df %>% mutate(item = category_lv2)
      }
      
      
      # ---- 2. –í–∑–∞—î–º–æ–¥—ñ—ó –∫–ª—ñ—î–Ω—Ç‚Äì–∫–∞—Ç–µ–≥–æ—Ä—ñ—è (0/1) ----
      # ---- 2. –í–∑–∞—î–º–æ–¥—ñ—ó –∫–ª—ñ—î–Ω—Ç‚Äì–∫–∞—Ç–µ–≥–æ—Ä—ñ—è (0/1) ----
      interactions <- df %>%
        select(client_id, item) %>%
        distinct() %>%
        mutate(value = 1)
      
      rv$interactions <- interactions
      
      # ---- 3. –û–±–º–µ–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –¥–æ TOP-k ----
      cat_counts <- interactions %>%
        count(item, name = "n_clients") %>%
        arrange(desc(n_clients))
      
      max_cats <- input$max_cats
      if (nrow(cat_counts) > max_cats) {
        keep_items <- cat_counts$item[1:max_cats]
        interactions <- interactions %>% filter(item %in% keep_items)
      } else {
        keep_items <- cat_counts$item
      }
      
      # ---- 4. –ú–∞—Ç—Ä–∏—Ü—è –∫–ª—ñ—î–Ω—Ç √ó item (0/1) ----
      # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ values_fn, —â–æ–± –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ —É–Ω–∏–∫–Ω—É—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ø–∏—Å–∫—ñ–≤ (list-columns)
      # ---- 4. –ú–∞—Ç—Ä–∏—Ü—è –∫–ª—ñ—î–Ω—Ç √ó item (0/1) ----
      
      # 1. –°—Ç–≤–æ—Ä—é—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –ø–∞—Ä–∏ —ñ –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ —á–∏—Å–ª–æ–≤–∏–π —Ç–∏–ø
      interactions_clean <- interactions %>%
        mutate(value = 1) %>%
        distinct(client_id, item, .keep_all = TRUE)
      
      # 2. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ pivot_wider –∑ values_fn. 
      # –¶–µ –ì–ê–†–ê–ù–¢–Ü–Ø: —è–∫—â–æ –∑–Ω–∞–π–¥–µ—Ç—å—Å—è –¥—É–±–ª—ñ–∫–∞—Ç, –≤—ñ–Ω –ø—Ä–æ—Å—Ç–æ –≤—ñ–∑—å–º–µ –º–∞–∫—Å–∏–º—É–º (1), 
      # —ñ –Ω—ñ—è–∫–æ–≥–æ —Å–ø–∏—Å–∫—É (list) –Ω–µ –≤–∏–Ω–∏–∫–Ω–µ.
      library(Matrix)
      
      tmp <- interactions %>%
        transmute(
          client_id = as.character(client_id),
          item      = as.character(item),
          value     = 1L
        ) %>%
        distinct(client_id, item, .keep_all = TRUE)
      
      i <- as.integer(factor(tmp$client_id))
      j <- as.integer(factor(tmp$item))
      
      purchase_sparse <- Matrix::sparseMatrix(
        i = i, j = j, x = tmp$value,
        dimnames = list(levels(factor(tmp$client_id)), levels(factor(tmp$item)))
      )
      
      purchase_matrix <- as.matrix(purchase_sparse)  # —è–∫—â–æ —Ç—Ä–µ–±–∞ —Å–∞–º–µ matrix –¥–∞–ª—ñ
      client_ids <- rownames(purchase_matrix)
      
      
      
      min_items_per_user <- 2
      
      keep_users <- rowSums(purchase_matrix > 0) >= min_items_per_user
      
      
      
      purchase_matrix <- purchase_matrix[keep_users, , drop = FALSE]
      
      client_ids <- client_ids[keep_users]
      
      rownames(purchase_matrix) <- client_ids
      
      
      
      max_users <- input$max_users
      
      if (nrow(purchase_matrix) > max_users) {
        
        set.seed(123)
        
        idx <- sample(seq_len(nrow(purchase_matrix)), max_users)
        
        purchase_matrix <- purchase_matrix[idx, , drop = FALSE]
        
      }
      
      
      storage.mode(purchase_matrix) <- "numeric"
      bin_mat <- as(purchase_matrix, "binaryRatingMatrix")
      
      # ---- 5. Train/Test split ----
      set.seed(123)
      n_users <- nrow(bin_mat)
      if (n_users < 5) {
        showNotification("–ó–∞–Ω–∞–¥—Ç–æ –º–∞–ª–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –¥–ª—è –ø–æ–±—É–¥–æ–≤–∏ –º–æ–¥–µ–ª—ñ.", type = "error")
        return(NULL)
      }
      
      train_id <- sample(seq_len(n_users), size = round(0.8 * n_users))
      train <- bin_mat[train_id, ]
      test  <- bin_mat[-train_id, ]
      
      # ---- 6. UBCF –º–æ–¥–µ–ª—å (Jaccard) ----
      # 1. –ó–∞–ª–∏—à–∞—î–º–æ –º–æ–¥–µ–ª—å –¥–ª—è –æ—Ü—ñ–Ω–∫–∏ —è–∫–æ—Å—Ç—ñ (–Ω–∞ 80% –¥–∞–Ω–∏—Ö)
      rec_val <- Recommender(train, "UBCF", parameter = list(method = "Jaccard", nn = 50))
      
      # 2. –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω—É –º–æ–¥–µ–ª—å –¥–ª—è –±—ñ–∑–Ω–µ—Å—É (–Ω–∞ 100% –¥–∞–Ω–∏—Ö)
      # –°–∞–º–µ –≤–æ–Ω–∞ –¥–∞—Å—Ç—å –Ω–∞–π–∫—Ä–∞—â—ñ –ø–æ—Ä–∞–¥–∏, –±–æ –∑–Ω–∞—î —ñ—Å—Ç–æ—Ä—ñ—é –∫–æ–∂–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
      rec_final <- Recommender(bin_mat, "UBCF", parameter = list(method = "Jaccard", nn = 50))
      
      
      
      top_n <- input$top_n
      
      # ---- 6A. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –ø–æ TEST ----
      pred_test <- predict(rec_val, newdata = test, n = top_n, type = "topNList")
      rec_list_test <- as(pred_test, "list")
      test_ids <- rownames(test)
      
      test_m <- as(test, "matrix")
      
      rec_list_test <- purrr::map2(
        .x = rec_list_test,
        .y = test_ids,
        ~{
          uid <- .y
          bought_items <- colnames(test_m)[test_m[uid, ] > 0]
          
          head(
            apply_rules(
              recs = .x,
              bought_items = bought_items,
              never_recommend = never_recommend,
              tobacco_cat = tobacco_cat,
              alcohol_cats = alcohol_cats,
              kids_cat = kids_cat,
              kids_signal = kids_signal,
              policy = policy
            ),
            top_n
          )
        }
      )
      
      
      rec_long <- purrr::map2_df(
        .x = rec_list_test,
        .y = test_ids,
        ~ tibble::tibble(client_id = .y, category = .x, rank = seq_along(.x))
      )
      
      if (nrow(rec_long) == 0) {
        showNotification("–ú–æ–¥–µ–ª—å –Ω–µ –∑–≥–µ–Ω–µ—Ä—É–≤–∞–ª–∞ –∂–æ–¥–Ω–æ—ó —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–∞–Ω—ñ.", type = "error")
        return(NULL)
      }
      
      rec_long <- rec_long %>% mutate(rank_score = top_n - rank + 1)
      
      # ---- 7. –û–¶–Ü–ù–ö–ê –Ø–ö–û–°–¢–Ü (—Ç—ñ–ª—å–∫–∏ –≤ –ª–æ–≥/–∫–æ–Ω—Å–æ–ª—å, –±–µ–∑ UI) ----
      hold <- make_holdout_newdata(bin_mat, keep_frac = 0.7, seed = 123)
      
      
      if (nrow(hold$given_mat) >= 10) {
        
        # 7A) Predictions model (holdout newdata)
        pred_hold <- predict(rec_val, newdata = hold$newdata, n = top_n, type = "topNList")
        recs_list <- as(pred_hold, "list")
        user_ids <- rownames(hold$newdata)
        
        # 7B) Popular baseline: —Ç–æ–ø –ø–æ–ø—É–ª—è—Ä–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –∑ train
        train_m <- as(train, "matrix")
        pop_counts <- colSums(train_m > 0)
        pop_items <- names(sort(pop_counts, decreasing = TRUE))
        
        make_pop_recs <- function(given_row, k) {
          already <- names(given_row)[given_row > 0]
          cand <- setdiff(pop_items, already)
          head(cand, k)
        }
        
        # 7C) Random baseline
        all_items <- colnames(hold$given_mat)
        make_rand_recs <- function(given_row, k) {
          already <- names(given_row)[given_row > 0]
          cand <- setdiff(all_items, already)
          if (length(cand) == 0) return(character(0))
          sample(cand, size = min(k, length(cand)))
        }
        
        # 7D) –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ –∫–ª—ñ—î–Ω—Ç–∞—Ö
        details <- purrr::map2_df(
          .x = user_ids,
          .y = seq_along(user_ids),
          ~{
            uid <- .x
            i <- .y
            
            given_row <- hold$given_mat[i, ]
            truth <- hold$truth[[uid]]
            
            rec_model <- recs_list[[i]]
            rec_pop <- make_pop_recs(given_row, top_n)
            rec_rand <- make_rand_recs(given_row, top_n)
            
            m1 <- calc_metrics_at_k(rec_model, truth, top_n)
            m2 <- calc_metrics_at_k(rec_pop, truth, top_n)
            m3 <- calc_metrics_at_k(rec_rand, truth, top_n)
            
            tibble::tibble(
              client_id = uid,
              truth_size = length(truth),
              
              model_precision = m1$precision,
              model_recall    = m1$recall,
              model_hit       = m1$hit,
              model_map       = m1$ap,
              model_ndcg      = m1$ndcg,
              
              pop_precision   = m2$precision,
              pop_recall      = m2$recall,
              pop_hit         = m2$hit,
              pop_map         = m2$ap,
              pop_ndcg        = m2$ndcg,
              
              rand_precision  = m3$precision,
              rand_recall     = m3$recall,
              rand_hit        = m3$hit,
              rand_map        = m3$ap,
              rand_ndcg       = m3$ndcg
            )
          }
        )
        
        summary_tbl <- tibble::tibble(
          Method = c("UBCF model", "Popular baseline", "Random baseline"),
          `Precision@K` = c(mean(details$model_precision, na.rm = TRUE),
                            mean(details$pop_precision,   na.rm = TRUE),
                            mean(details$rand_precision,  na.rm = TRUE)),
          `Recall@K`    = c(mean(details$model_recall, na.rm = TRUE),
                            mean(details$pop_recall,   na.rm = TRUE),
                            mean(details$rand_recall,  na.rm = TRUE)),
          `HitRate@K`   = c(mean(details$model_hit, na.rm = TRUE),
                            mean(details$pop_hit,   na.rm = TRUE),
                            mean(details$rand_hit,  na.rm = TRUE)),
          `MAP@K`       = c(mean(details$model_map, na.rm = TRUE),
                            mean(details$pop_map,   na.rm = TRUE),
                            mean(details$rand_map,  na.rm = TRUE)),
          `nDCG@K`      = c(mean(details$model_ndcg, na.rm = TRUE),
                            mean(details$pop_ndcg,   na.rm = TRUE),
                            mean(details$rand_ndcg,  na.rm = TRUE))
        ) %>%
          dplyr::mutate(
            `Precision@K` = round(`Precision@K`, 4),
            `Recall@K`    = round(`Recall@K`, 4),
            `HitRate@K`   = round(`HitRate@K`, 4),
            `MAP@K`       = round(`MAP@K`, 4),
            `nDCG@K`      = round(`nDCG@K`, 4)
          )
        
        # –ó–±–µ—Ä–µ–∂–µ–º–æ –≤ rv (–Ω–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫)
        rv$quality_summary <- summary_tbl
        rv$quality_details <- details
        
        # –í–∏–≤—ñ–¥ —Ç—ñ–ª—å–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª—å / –ª–æ–≥–∏
        message("=== RECSYS QUALITY (Holdout on TEST) ===")
        message("K = ", top_n, ", holdout keep_frac = 0.7")
        print(summary_tbl)
        message("---- details (first 20 rows) ----")
        print(head(details, 20))
        message("=== END RECSYS QUALITY ===")
        
      } else {
        rv$quality_summary <- tibble::tibble(
          Message = "Not enough test users with >=2 purchases for holdout evaluation."
        )
        rv$quality_details <- NULL
        
        message("=== RECSYS QUALITY ===")
        message("Not enough test users with >=2 purchases for holdout evaluation.")
        message("=== END RECSYS QUALITY ===")
      }
      
      
      # ---- –¢–û–ü –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –ø–æ TEST (–∑—Ä–æ–∑—É–º—ñ–ª–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞) ----
      n_test_clients <- rec_long %>% dplyr::summarise(n = dplyr::n_distinct(client_id)) %>% dplyr::pull(n)
      
      top_categories_test <- rec_long %>%
        dplyr::filter(!is.na(category), category != "", category != "OTHER") %>%
        dplyr::group_by(category) %>%
        dplyr::summarise(
          `–ü–æ–ø–∏—Ç –∑–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è–º–∏ (—ñ–Ω–¥–µ–∫—Å)` = sum(rank_score, na.rm = TRUE),
          `–ö-—Å—Ç—å –∫–ª—ñ—î–Ω—Ç—ñ–≤, –∫–æ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ` = dplyr::n_distinct(client_id),
          `–°–µ—Ä–µ–¥–Ω—è —Å–∏–ª–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó (1‚ÄìN)` = round(mean(rank_score, na.rm = TRUE), 2),
          .groups = "drop"
        ) %>%
        dplyr::mutate(`–û—Ö–æ–ø–ª–µ–Ω–Ω—è, % –∫–ª—ñ—î–Ω—Ç—ñ–≤` = round(100 * `–ö-—Å—Ç—å –∫–ª—ñ—î–Ω—Ç—ñ–≤, –∫–æ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ` / n_test_clients, 1)) %>%
        dplyr::arrange(dplyr::desc(`–ü–æ–ø–∏—Ç –∑–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è–º–∏ (—ñ–Ω–¥–µ–∫—Å)`), dplyr::desc(`–ö-—Å—Ç—å –∫–ª—ñ—î–Ω—Ç—ñ–≤, –∫–æ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ`)) %>%
        dplyr::slice_head(n = 20)
      
      rv$top_categories_test <- top_categories_test
      
      
      
      
      
      # ---- 6B. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –ø–æ –í–°–Ü–• ----
      # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω—É –º–æ–¥–µ–ª—å –Ω–∞ –ø–æ–≤–Ω–∏—Ö –¥–∞–Ω–∏—Ö
      # ---- 6B. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –ø–æ –í–°–Ü–• ----
      pred_all <- predict(rec_final, newdata = bin_mat, n = top_n, type = "topNList")
      rec_list_all <- as(pred_all, "list")
      all_ids <- rownames(bin_mat)
      
      # –º–∞—Ç—Ä–∏—Ü—è –ø–æ–∫—É–ø–æ–∫ –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è bought_items –ø–æ –∫–æ–∂–Ω–æ–º—É –∫–ª—ñ—î–Ω—Ç—É
      bin_m <- as(bin_mat, "matrix")
      
      rec_list_all <- purrr::map2(
        .x = rec_list_all,
        .y = all_ids,
        ~{
          uid <- .y
          bought_items <- colnames(bin_m)[bin_m[uid, ] > 0]
          
          out <- apply_rules(
            recs = .x,
            bought_items = bought_items,
            never_recommend = never_recommend,
            tobacco_cat = tobacco_cat,
            alcohol_cats = alcohol_cats,
            kids_cat = kids_cat,
            kids_signal = kids_signal,
            policy = policy
          )
          
          head(out, top_n)
        }
      )
      
      
      # –≤–∞–∂–ª–∏–≤–æ: —è–∫—â–æ –ø—ñ—Å–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π —Å—Ç–∞–ª–æ –º–µ–Ω—à–µ –Ω—ñ–∂ top_n ‚Äî —Ü–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
      # –∞–ª–µ —Ç–∏ –º–æ–∂–µ—à –Ω–µ —Ö–æ—Ç—ñ—Ç–∏ "–ø–æ—Ä–æ–∂–Ω—ñ—Ö" –∫–ª—ñ—î–Ω—Ç—ñ–≤, —Ç–æ–¥—ñ:
      rec_list_all <- lapply(rec_list_all, function(x) head(x, top_n))
      
      
      rec_long_all <- purrr::map2_df(
        .x = rec_list_all,
        .y = all_ids,
        ~ tibble::tibble(client_id = .y, category = .x, rank = seq_along(.x))
      ) %>%
        mutate(rank_score = top_n - rank + 1)
      
      n_all_clients <- rec_long_all %>% dplyr::summarise(n = dplyr::n_distinct(client_id)) %>% dplyr::pull(n)
      
      top_categories_all <- rec_long_all %>%
        dplyr::filter(!is.na(category), category != "", category != "OTHER") %>%
        dplyr::group_by(category) %>%
        dplyr::summarise(
          `–Ü–Ω–¥–µ–∫—Å –ø–æ–ø–∏—Ç—É` = sum(rank_score, na.rm = TRUE),
          `–ö-—Å—Ç—å –∫–ª—ñ—î–Ω—Ç—ñ–≤, –∫–æ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ` = dplyr::n_distinct(client_id),
          `–°–µ—Ä–µ–¥–Ω—è —Å–∏–ª–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó` = round(mean(rank_score, na.rm = TRUE), 2),
          .groups = "drop"
        ) %>%
        dplyr::mutate(`–û—Ö–æ–ø–ª–µ–Ω–Ω—è, % –∫–ª—ñ—î–Ω—Ç—ñ–≤` = round(100 * `–ö-—Å—Ç—å –∫–ª—ñ—î–Ω—Ç—ñ–≤, –∫–æ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ` / n_all_clients, 1)) %>%
        dplyr::arrange(dplyr::desc(`–Ü–Ω–¥–µ–∫—Å –ø–æ–ø–∏—Ç—É`), dplyr::desc(`–ö-—Å—Ç—å –∫–ª—ñ—î–Ω—Ç—ñ–≤, –∫–æ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ`)) %>%
        dplyr::slice_head(n = 20)
      
      rv$top_categories_all <- top_categories_all
      
      # ---- rank_matrix ----
      library(Matrix)
      
      rank_tmp <- rec_long_all %>%
        transmute(
          client_id  = as.character(client_id),
          category   = as.character(category),
          rank_score = as.numeric(rank_score)
        ) %>%
        filter(!is.na(category), category != "") %>%
        distinct(client_id, category, .keep_all = TRUE)
      
      ii <- as.integer(factor(rank_tmp$client_id))
      jj <- as.integer(factor(rank_tmp$category))
      
      rank_sparse <- Matrix::sparseMatrix(
        i = ii, j = jj, x = rank_tmp$rank_score,
        dimnames = list(levels(factor(rank_tmp$client_id)),
                        levels(factor(rank_tmp$category)))
      )
      
      rank_matrix_export <- as.data.frame(as.matrix(rank_sparse)) %>%
        tibble::rownames_to_column("client_id")
      
      
      
      # ---- purchase_export (–≤—Å—ñ –∫–ª—ñ—î–Ω—Ç–∏ —É –º–∞—Ç—Ä–∏—Ü—ñ) ----
      purchase_export <- purchase_matrix %>% as.data.frame() %>% tibble::rownames_to_column("client_id")
      
      # ---- rec_list_export ----
      rec_list_export <- rec_long_all %>% arrange(client_id, rank) %>% select(client_id, category, rank_score)
      # ---- combined_export (—Ç—ñ–ª—å–∫–∏ –∫–ª—ñ—î–Ω—Ç–∏ –∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è–º–∏) ----
      # !!! –ù–ï –ß–Ü–ü–ê–Æ –õ–û–ì–Ü–ö–£ - —è–∫ —É —Ç–µ–±–µ
      recommended_ids <- unique(rec_long_all$client_id)
      
      purchase_matrix_recs <- purchase_matrix[rownames(purchase_matrix) %in% recommended_ids, , drop = FALSE]
      purchase_export_recs <- purchase_matrix_recs %>%
        as.data.frame() %>%
        tibble::rownames_to_column("client_id") %>%
        mutate(client_id = as.character(client_id)) %>%
        rename_with(~ paste0("buy_", .x), -client_id)
      
      rank_export_recs <- rank_matrix_export %>%
        mutate(client_id = as.character(client_id)) %>%
        filter(client_id %in% recommended_ids) %>%
        rename_with(~ paste0("rec_", .x), -client_id)
      
      
      combined_export <- purchase_export_recs %>% left_join(rank_export_recs, by = "client_id")
      combined_export[is.na(combined_export)] <- 0
      
      
      
      # ---- –ó–±–µ—Ä—ñ–≥–∞—î–º–æ ----
      rv$rank_matrix_export <- rank_matrix_export
      rv$purchase_dim <- dim(purchase_matrix)
      rv$purchase_export <- purchase_export
      rv$rec_list_export <- rec_list_export
      rv$combined_export <- combined_export
      
      # >>> NEW: client dropdown options
      rv$client_options <- sort(unique(combined_export$client_id))
      
      showNotification("–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ", type = "message")
      
      incProgress(1, detail = "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è")
    })
    
    
    
    shinyjs::hide("calc_status")
    enable("run")
    
  })
  
  # ---- OUTPUTS ----
  output$top_categories_all <- renderTable({
    req(rv$top_categories_all)
    rv$top_categories_all
  })
  
  output$top_categories_test <- renderTable({
    req(rv$top_categories_test)
    rv$top_categories_test
  })
  
  output$preview <- renderTable({
    req(rv$rank_matrix_export)
    head(rv$rank_matrix_export)
  })
  
  output$summary <- renderPrint({
    req(rv$rank_matrix_export, rv$purchase_dim, rv$combined_export)
    list(
      "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–ª—ñ—î–Ω—Ç—ñ–≤ —É –º–∞—Ç—Ä–∏—Ü—ñ" = rv$purchase_dim[1],
      "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ–π —É –º–∞—Ç—Ä–∏—Ü—ñ" = rv$purchase_dim[2],
      "–ö–ª—ñ—î–Ω—Ç—ñ–≤ –∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è–º–∏ (test)" = length(unique(rv$rank_matrix_export$client_id)),
      "–†–æ–∑–º—ñ—Ä —Ä–∞–Ω–≥–æ–≤–æ—ó –º–∞—Ç—Ä–∏—Ü—ñ (—Ä—è–¥–∫–∏ √ó —Å—Ç–æ–≤–ø—Ü—ñ)" = dim(rv$rank_matrix_export),
      "–†–æ–∑–º—ñ—Ä combined (—Ä—è–¥–∫–∏ √ó —Å—Ç–æ–≤–ø—Ü—ñ)" = dim(rv$combined_export)
    )
  })
  
  # >>> NEW: KPI cards output
  output$kpi_cards <- renderUI({
    req(rv$purchase_dim, rv$combined_export, rv$top_categories_test)
    
    n_clients <- rv$purchase_dim[1]
    n_cats <- rv$purchase_dim[2]
    n_recommended <- nrow(rv$combined_export)
    coverage <- round(100 * n_recommended / n_clients, 1)
    
    # —Å–µ—Ä–µ–¥–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π (–ø–æ rec_* –∑ >0)
    rec_cols <- grep("^rec_", names(rv$combined_export), value = TRUE)
    avg_recs <- if (length(rec_cols) > 0) {
      mean(rowSums(rv$combined_export[, rec_cols, drop = FALSE] > 0))
    } else 0
    avg_recs <- round(avg_recs, 2)
    
    div(class = "kpi-row",
        div(class = "kpi-card",
            div(class="kpi-title", "–ö–ª—ñ—î–Ω—Ç—ñ–≤ —É –º–æ–¥–µ–ª—ñ"),
            div(class="kpi-value", format(n_clients, big.mark=" ")),
            div(class="kpi-sub", paste0("–ö–∞—Ç–µ–≥–æ—Ä—ñ–π: ", format(n_cats, big.mark=" ")))
        ),
        div(class = "kpi-card",
            div(class="kpi-title", "–ö–ª—ñ—î–Ω—Ç—ñ–≤ –∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è–º–∏"),
            div(class="kpi-value", format(n_recommended, big.mark=" ")),
            div(class="kpi-sub", paste0("–ü–æ–∫—Ä–∏—Ç—Ç—è: ", coverage, "%"))
        ),
        div(class = "kpi-card",
            div(class="kpi-title", "–°–µ—Ä–µ–¥–Ω—è –∫-—Å—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π"),
            div(class="kpi-value", avg_recs)
        ),
        div(class = "kpi-card",
            div(class="kpi-title", "–¢–û–ü-1 –∫–∞—Ç–µ–≥–æ—Ä—ñ—è"),
            div(class="kpi-value", rv$top_categories_all$category[1] %||% "-"),
            div(class="kpi-sub", "–∑–∞ —ñ–Ω–¥–µ–∫—Å–æ–º –ø–æ–ø–∏—Ç—É")
        )
    )
  })
  
  # >>> NEW: per-client view UI + table
  output$client_picker_ui <- renderUI({
    req(rv$client_options)
    selectInput("client_pick", "–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞", choices = rv$client_options, selected = rv$client_options[1])
  })
  
  output$client_view <- renderTable({
    req(rv$combined_export, input$client_pick)
    dfc <- rv$combined_export %>% filter(client_id == input$client_pick)
    
    buy_cols <- names(dfc)[startsWith(names(dfc), "buy_")]
    rec_cols <- names(dfc)[startsWith(names(dfc), "rec_")]
    
    bought <- tibble(
      type = "–ü–æ–∫—É–ø–∫–∏",
      category = sub("^buy_", "", buy_cols),
      value = as.numeric(dfc[1, buy_cols, drop = TRUE])
    ) %>% filter(value == 1) %>% select(type, category)
    
    recs <- tibble(
      type = "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó",
      category = sub("^rec_", "", rec_cols),
      score = as.numeric(dfc[1, rec_cols, drop = TRUE])
    ) %>% filter(score > 0) %>% arrange(desc(score)) %>% transmute(type, category)
    
    bind_rows(bought, recs)
  })
  
  # ---- DOWNLOADS ----
  output$download_rank <- downloadHandler(
    filename = function() {
      base <- if (!is.null(input$file$name)) tools::file_path_sans_ext(input$file$name) else "demo"
      paste0("recommendations_rank_matrix_", base, ".xlsx")
    },
    content = function(file) {
      req(rv$rank_matrix_export)
      openxlsx::write.xlsx(rv$rank_matrix_export, file)
    }
  )
  
  output$download_purchase <- downloadHandler(
    filename = function() {
      base <- if (!is.null(input$file$name)) tools::file_path_sans_ext(input$file$name) else "demo"
      paste0("client_category_matrix_", base, ".xlsx")
    },
    content = function(file) {
      req(rv$purchase_export)
      openxlsx::write.xlsx(rv$purchase_export, file)
    }
  )
  
  output$download_rec_list <- downloadHandler(
    filename = function() {
      base <- if (!is.null(input$file$name)) tools::file_path_sans_ext(input$file$name) else "demo"
      paste0("recommendations_list_", base, ".xlsx")
    },
    content = function(file) {
      req(rv$rec_list_export)
      openxlsx::write.xlsx(rv$rec_list_export, file)
    }
  )
  
  output$combined_table <- renderDT({
    req(rv$combined_export)
    
    df <- rv$combined_export
    
    selected_cats <- input$buy_multi_filter
    mode <- input$buy_multi_mode %||% "AND"
    
    if (!is.null(selected_cats) && length(selected_cats) > 0) {
      cols <- paste0("buy_", selected_cats)
      cols <- cols[cols %in% names(df)]  # –±–µ–∑–ø–µ–∫–∞
      
      if (length(cols) > 0) {
        mat <- as.matrix(df[, cols, drop = FALSE])
        
        keep <- if (mode == "AND") {
          rowSums(mat == 1) == ncol(mat)   # —É—Å—ñ –æ–±—Ä–∞–Ω—ñ = 1
        } else {
          rowSums(mat == 1) >= 1           # —Ö–æ—á–∞ –± –æ–¥–Ω–∞ = 1
        }
        
        df <- df[keep, , drop = FALSE]
      }
    }
    
    buy_idx <- which(startsWith(names(df), "buy_"))
    rec_idx <- which(startsWith(names(df), "rec_"))
    client_idx <- which(names(df) == "client_id")
    
    dt <- DT::datatable(
      df,
      rownames = FALSE,
      extensions = c("Scroller"),
      options = list(
        scrollX = TRUE,
        scrollY = 520,
        scroller = TRUE,
        pageLength = 25,
        lengthMenu = c(10, 25, 50, 100),
        dom = "Blfrtip"
      )
    )
    
    # –±–∞–∑–æ–≤–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è: –ø–æ–∫—É–ø–∫–∏ vs —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
    if (length(buy_idx) > 0) {
      dt <- DT::formatStyle(
        dt,
        columns = buy_idx,
        backgroundColor = "#D9EEF9"  # —è–∫ —É —Ç–≤–æ—î–º—É Excel –¥–ª—è buy_
      )
    }
    if (length(rec_idx) > 0) {
      dt <- DT::formatStyle(
        dt,
        columns = rec_idx,
        backgroundColor = "#F1D7F1"  # —è–∫ —É —Ç–≤–æ—î–º—É Excel –¥–ª—è rec_
      )
    }
    
    # –≤–∏–¥—ñ–ª—è—î–º–æ client_id
    if (length(client_idx) > 0) {
      dt <- DT::formatStyle(
        dt,
        columns = client_idx,
        fontWeight = "700",
        backgroundColor = "#FFFFFF"
      )
    }
    
    dt
  })
  
  
  
  
  # !!! download_combined ‚Äî –∑–∞–ª–∏—à–∏–≤ —Ç–≤–æ—é –ª–æ–≥—ñ–∫—É —ñ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
  output$download_combined <- downloadHandler(
    filename = function() {
      base <- if (!is.null(input$file$name)) tools::file_path_sans_ext(input$file$name) else "demo"
      paste0("combined_purchases_and_recs_", base, ".xlsx")
    },
    content = function(file) {
      req(rv$combined_export)
      df_out <- rv$combined_export
      
      wb <- openxlsx::createWorkbook()
      openxlsx::addWorksheet(wb, "data")
      openxlsx::writeData(wb, "data", df_out)
      
      openxlsx::addWorksheet(wb, "read_me")
      readme_text <- c(
        "–Ø–∫ —á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª",
        "",
        "1) –ö–æ–ª–æ–Ω–∫–∏ buy_* (–ø–æ–∫—É–ø–∫–∏):",
        " ‚Ä¢ 1 ‚Äî –∫–ª—ñ—î–Ω—Ç –∫—É–ø—É–≤–∞–≤ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é",
        " ‚Ä¢ 0 ‚Äî –∫–ª—ñ—î–Ω—Ç –Ω–µ –∫—É–ø—É–≤–∞–≤ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é",
        "",
        "2) –ö–æ–ª–æ–Ω–∫–∏ rec_* (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó):",
        " ‚Ä¢ —á–∏—Å–ª–æ > 0 ‚Äî –∫–∞—Ç–µ–≥–æ—Ä—ñ—è —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ (—á–∏–º –±—ñ–ª—å—à–µ, —Ç–∏–º —Å–∏–ª—å–Ω—ñ—à–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è)",
        " ‚Ä¢ 0 ‚Äî –∫–∞—Ç–µ–≥–æ—Ä—ñ—è –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞",
        "",
        "–ü—Ä–∏–º—ñ—Ç–∫–∞:",
        "–§–∞–π–ª –º—ñ—Å—Ç–∏—Ç—å –ª–∏—à–µ –∫–ª—ñ—î–Ω—Ç—ñ–≤, –¥–ª—è —è–∫–∏—Ö –º–æ–¥–µ–ª—å –∑–≥–µ–Ω–µ—Ä—É–≤–∞–ª–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó."
      )
      openxlsx::writeData(wb, "read_me", data.frame(text = readme_text), colNames = FALSE)
      
      header_style <- openxlsx::createStyle(
        textDecoration = "bold",
        fgFill = "#1B065E",
        fontColour = "#FFFFFF",
        halign = "center",
        valign = "center",
        border = "Bottom"
      )
      
      openxlsx::addStyle(
        wb, "data", style = header_style,
        rows = 1, cols = 1:ncol(df_out),
        gridExpand = TRUE, stack = TRUE
      )
      
      buy_cols <- which(startsWith(names(df_out), "buy_"))
      rec_cols <- which(startsWith(names(df_out), "rec_"))
      buy_style <- openxlsx::createStyle(fgFill = "#D9EEF9")
      rec_style <- openxlsx::createStyle(fgFill = "#F1D7F1")
      
      if (length(buy_cols) > 0) {
        openxlsx::addStyle(
          wb, "data", style = buy_style,
          rows = 2:(nrow(df_out) + 1), cols = buy_cols,
          gridExpand = TRUE, stack = TRUE
        )
      }
      if (length(rec_cols) > 0) {
        openxlsx::addStyle(
          wb, "data", style = rec_style,
          rows = 2:(nrow(df_out) + 1), cols = rec_cols,
          gridExpand = TRUE, stack = TRUE
        )
      }
      
      openxlsx::freezePane(wb, "data", firstRow = TRUE)
      openxlsx::setColWidths(wb, "data", cols = 1:ncol(df_out), widths = "auto")
      openxlsx::setColWidths(wb, "read_me", cols = 1, widths = 70)
      openxlsx::saveWorkbook(wb, file, overwrite = TRUE)
    }
  )
}

# helper for UI (safe null)
`%||%` <- function(x, y) if (is.null(x) || length(x) == 0 || is.na(x)) y else x

# ---- –ó–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É ----
shinyApp(ui, server)

